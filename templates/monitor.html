{% extends "base.html" %}

{% block title %}Add Monitor - ShopMate{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card shadow">
            <div class="card-header">
                <h4 class="mb-0">
                    <i data-feather="plus" class="me-2"></i>
                    Add New Product to ShopMate
                </h4>
            </div>
            <div class="card-body">
                <form method="POST" id="monitorForm">
                    <!-- Product URL -->
                    <div class="mb-4">
                        <label for="product_url" class="form-label">
                            <i data-feather="link" class="me-2"></i>
                            Product URL *
                        </label>
                        <input type="url" class="form-control" id="product_url" name="product_url" 
                               placeholder="https://example.com/product" required>
                        <div class="form-text">
                            Paste the URL of the product you want to monitor
                        </div>
                    </div>

                    <!-- Monitoring Conditions -->
                    <div class="mb-4">
                        <h5>
                            <i data-feather="settings" class="me-2"></i>
                            Monitoring Conditions *
                        </h5>
                        <p class="text-muted">Select what you want to be notified about:</p>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <!-- Stock Check -->
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="check_stock" name="check_stock">
                                    <label class="form-check-label" for="check_stock">
                                        <strong>Stock Availability</strong>
                                        <br>
                                        <small class="text-muted">Notify when product comes back in stock</small>
                                    </label>
                                </div>

                                <!-- Size Check -->
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="check_size" name="check_size">
                                    <label class="form-check-label" for="check_size">
                                        <strong>Size Availability</strong>
                                        <br>
                                        <small class="text-muted">Notify when specific size becomes available</small>
                                    </label>
                                </div>
                                
                                <div class="mb-3" id="size_input" style="display: none;">
                                    <input type="text" class="form-control" id="desired_size" name="desired_size" 
                                           placeholder="e.g., M, L, XL, 42, etc.">
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <!-- Delivery Check -->
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="check_delivery" name="check_delivery">
                                    <label class="form-check-label" for="check_delivery">
                                        <strong>Delivery Available</strong>
                                        <br>
                                        <small class="text-muted">Notify when delivery becomes possible</small>
                                    </label>
                                </div>

                                <!-- Price Check -->
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="check_price" name="check_price">
                                    <label class="form-check-label" for="check_price">
                                        <strong>Price Drop</strong>
                                        <br>
                                        <small class="text-muted">Notify when price drops to target or below</small>
                                    </label>
                                </div>
                                
                                <div class="mb-3" id="price_input" style="display: none;">
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" class="form-control" id="target_price" name="target_price" 
                                               placeholder="0.00" step="0.01" min="0">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Notification Preferences -->
                    <div class="mb-4">
                        <h5>
                            <i data-feather="bell" class="me-2"></i>
                            Notification Preferences *
                        </h5>
                        <p class="text-muted">Choose how you want to receive notifications:</p>
                        
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="radio" id="email_only" name="notification_preference" 
                                   value="email" checked>
                            <label class="form-check-label" for="email_only">
                                <i data-feather="mail" class="me-2"></i>
                                <strong>Email Only</strong>
                                <br>
                                <small class="text-muted">Receive notifications via email only</small>
                            </label>
                        </div>
                        
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="radio" id="email_whatsapp" name="notification_preference" 
                                   value="email_whatsapp">
                            <label class="form-check-label" for="email_whatsapp">
                                <i data-feather="message-circle" class="me-2"></i>
                                <strong>Email + WhatsApp</strong>
                                <br>
                                <small class="text-muted">Receive notifications via both email and WhatsApp</small>
                            </label>
                        </div>
                        

                    </div>

                    <!-- Contact Information -->
                    <div class="mb-4">
                        <h5>
                            <i data-feather="user" class="me-2"></i>
                            Contact Information
                        </h5>
                        
                        <div class="mb-3">
                            <label for="email" class="form-label">
                                <i data-feather="mail" class="me-2"></i>
                                Email Address *
                            </label>
                            <input type="email" class="form-control" id="email" name="email" 
                                   placeholder="your.email@example.com" required
                                   value="{{ user.email if user.email }}">
                        </div>
                        
                        <div class="mb-3" id="phone_input" style="display: none;">
                            <label for="phone_number" class="form-label">
                                <i data-feather="phone" class="me-2"></i>
                                Phone Number (for WhatsApp) *
                            </label>
                            <p class="text-warning mb-2">
                                <small><strong>Setup Required:</strong> First send "join longer-before" to +14155238886 on WhatsApp</small>
                            </p>
                            <input type="tel" class="form-control" id="phone_number" name="phone_number" 
                                   placeholder="+1234567890"
                                   value="{{ user.phone_number if user.phone_number }}">
                            <div class="form-text">
                                Include country code (e.g., +1 for US, +44 for UK)
                            </div>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i data-feather="play" class="me-2"></i>
                            Start Monitoring
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Information Card -->
        <div class="card mt-4">
            <div class="card-body">
                <h6>
                    <i data-feather="info" class="me-2"></i>
                    How ShopMate Works
                </h6>
                <ul class="mb-0">
                    <li>We check your product every 5 minutes for the conditions you selected</li>
                    <li>When any condition is met, we'll send you a notification immediately</li>
                    <li>Monitoring stops automatically after sending a notification</li>
                    <li>You can monitor multiple products simultaneously</li>
                    <li>WhatsApp notifications require a verified Twilio account</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Show/hide conditional fields based on form selections
    document.addEventListener('DOMContentLoaded', function() {
        // Size input toggle
        const checkSize = document.getElementById('check_size');
        const sizeInput = document.getElementById('size_input');
        const desiredSize = document.getElementById('desired_size');
        
        checkSize.addEventListener('change', function() {
            if (this.checked) {
                sizeInput.style.display = 'block';
                desiredSize.required = true;
            } else {
                sizeInput.style.display = 'none';
                desiredSize.required = false;
                desiredSize.value = '';
            }
        });
        
        // Price input toggle
        const checkPrice = document.getElementById('check_price');
        const priceInput = document.getElementById('price_input');
        const targetPrice = document.getElementById('target_price');
        
        checkPrice.addEventListener('change', function() {
            if (this.checked) {
                priceInput.style.display = 'block';
                targetPrice.required = true;
            } else {
                priceInput.style.display = 'none';
                targetPrice.required = false;
                targetPrice.value = '';
            }
        });
        
        // Phone input toggle based on notification preference
        const emailOnly = document.getElementById('email_only');
        const emailWhatsapp = document.getElementById('email_whatsapp');
        const phoneInput = document.getElementById('phone_input');
        const phoneNumber = document.getElementById('phone_number');
        
        function togglePhoneInput() {
            if (emailWhatsapp.checked) {
                phoneInput.style.display = 'block';
                phoneNumber.required = true;
            } else {
                phoneInput.style.display = 'none';
                phoneNumber.required = false;
            }
        }
        
        emailOnly.addEventListener('change', togglePhoneInput);
        emailWhatsapp.addEventListener('change', togglePhoneInput);
        
        // Form validation
        document.getElementById('monitorForm').addEventListener('submit', function(e) {
            const conditions = ['check_stock', 'check_size', 'check_delivery', 'check_price'];
            const isAnyConditionChecked = conditions.some(id => document.getElementById(id).checked);
            
            if (!isAnyConditionChecked) {
                e.preventDefault();
                alert('Please select at least one monitoring condition.');
                return false;
            }
        });
    });
</script>
{% endblock %}
